#lang at-exp racket

(require syntax/parse
         mutate
         mutate/traversal
         mutate/logger
         "./read-module.rkt"
         )

(define stx->mutants
  (build-mutation-engine
   #:mutators
   (define-id-mutator swap-ids
     [/ #:-> modulo]
     [/ #:-> *]
     [not #:-> identity]
     [and #:<-> or]
     [when #:<-> unless]
     [> #:<-> >=]
     [< #:<-> <=]
     )
   (define-simple-mutator (div-swap stx)
     #:pattern ({~datum /} e1 e2)
     #' (/ e2 e1))
   (define-constant-mutator (constant-swap v)
     [(? number?) #:-> (- v)])
   #:syntax-only
   #:top-level-selector select-define-body
   #:streaming
   #:module-mutator))

(define (get-mutants p)
  (stx->mutants (read-module p)))

;; create a listener that is interested in all
;; messages on the fooabc logger with topic 'debug or higher
(define log-receiver
  (make-log-receiver mutate-logger 'info))

(define score
  (for/fold ([failure 0]
             [total 0]
             #:result (/ failure total))
            ([mutant-stx (get-mutants "test-files/t1.rkt")])
    (define temp (make-temporary-file  "mutant-~a"))
    (write-to-file (syntax->datum mutant-stx)
                   temp
                   #:exists 'replace)
    ;; the handling of the logger here is weird. All of the
    ;; messages (events) in this queue are already queued before
    ;; the loop starts, generated by get-mutants. This code
    ;; pulls them out one at a time, and I believe they will
    ;; have to come out in the right order. I'm kind of not a fan
    ;; of this way of writing the code. Indeed, it seems a bit
    ;; weird to use a logger here at all.
    (match (sync log-receiver)
      [(vector level message (list type from-stx to-stx) logger-topic)
       ;; print out the message:
    
       (printf "\n\nMutator used: ~e\n" message)
       (printf "Mutant source: ~v\n" from-stx)
       (define tests-pass?
         (system* (find-executable-path "raco")
                  "test"
                  temp))
       (delete-file temp)
       (values (+ failure (if tests-pass? 0 1))
               (add1 total))]
      [other (error 'message "unexpected log message: ~e" other)])))


(displayln (~a "\n\nMutation score: " (~r score)))

#;(thread
 (Î» ()
   ;; run infinitely:
   (let loop ()
     ;; block until a message is received:
     (define message
       (sync log-receiver))
     ;; print out the message:
     (printf "\n\nMutator used: ~e" message)
     ;; continue waiting:
     (loop))));#